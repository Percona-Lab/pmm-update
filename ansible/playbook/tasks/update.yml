---
# This playbook contains tasks executed during PMM Server update.

- hosts: localhost
  become: yes
  gather_facts: yes
  vars:
    pmm_packages:
      - percona-grafana
      - percona-prometheus
      - percona-qan-api2
      - percona-qan-app
      - percona-dashboards
      - percona-alertmanager
      - pmm-server
      - pmm-managed
      - pmm-update
      - percona-clickhouse-client
      - percona-clickhouse-server
      - pmm2-client
      - dbaas-tools
    pmm_rendering_dependencies:
      - libXcomposite
      - libXdamage
      - libXtst
      - cups
      - libXScrnSaver
      - pango
      - atk
      - adwaita-cursor-theme
      - adwaita-icon-theme
      - alsa-lib
      - at
      - at-spi2-atk
      - at-spi2-core
      - cairo-gobject
      - colord-libs
      - dconf
      - desktop-file-utils
      - ed
      - emacs-filesystem
      - gdk-pixbuf2
      - glib-networking
      - gnutls
      - gsettings-desktop-schemas
      - gtk-update-icon-cache
      - gtk3
      - hicolor-icon-theme
      - jasper-libs
      - json-glib
      - libappindicator-gtk3
      - libdbusmenu
      - libdbusmenu-gtk3
      - libepoxy
      - liberation-fonts
      - liberation-narrow-fonts
      - liberation-sans-fonts
      - liberation-serif-fonts
      - libgusb
      - libindicator-gtk3
      - libmodman
      - libproxy
      - libsoup
      - libwayland-cursor
      - libwayland-egl
      - libxkbcommon
      - m4
      - mailx
      - nettle
      - patch
      - psmisc
      - redhat-lsb-core
      - redhat-lsb-submod-security
      - rest
      - spax
      - time
      - trousers
      - xdg-utils
      - xkeyboard-config

  tasks:
    # Replace forking type with simple. New config will be applied after next reboot.
    - name: Configure systemd
      when: ansible_virtualization_type != "docker"
      copy:
        src: supervisord.service
        dest: /usr/lib/systemd/system/supervisord.service
        mode: 0644

    - name: Remove old supervisord service confiuration
      when: ansible_virtualization_type != "docker"
      file:
        path: /etc/systemd/system/supervisord.service
        state: absent

    # See https://github.com/Supervisor/supervisor/issues/1264 for explanation
    # why we do reread + stop/remove/add instead of using supervisorctl Ansible module.

    - name: Reread supervisord configuration
      command: supervisorctl reread
      register: reread_result
      changed_when: "'No config updates to processes' not in reread_result.stdout"

    - name: Check reread results
      debug: var=reread_result.stdout_lines

    - name: Remove old packages
      yum:
        state: absent
        name:
          - mariadb-libs  # https://jira.percona.com/browse/PMM-5215

    # Split download and update to produce a bit more of progress output.

    - name: Download pmm2 packages
      yum:
        name: "{{ pmm_packages }}"
        state: latest
        download_only: yes

    - name: Update pmm2 packages
      yum:
        name: "{{ pmm_packages }}"
        state: latest

    - name: Install rendering plugin dependencies
      yum:
        name: "{{ pmm_rendering_dependencies }}"
        state: latest

    - name: Update system packages
      yum:
        name: '*'
        state: latest
        security: yes

    # Fix things that should be fixed before restarts.

    - name: Check pg_stat_statements extension
      postgresql_ext:
        db: postgres
        name: pg_stat_statements

    # https://jira.percona.com/browse/PMM-5271
    - name: Check volume size
      when: ansible_virtualization_type != "docker"
      replace:
        dest: /var/lib/cloud/scripts/per-boot/resize-xfs
        regexp: 'set -o errexit'
        replace: ''

    - name: Update nginx configuration
      file: name=/etc/nginx/conf.d/default.conf state=absent

    - name: Check nginx configuration
      command: nginx -t
      changed_when: False

    - name: Enable external snapshorts in Grafana
      ini_file:
        dest: /etc/grafana/grafana.ini
        section: snapshots
        option: external_enabled
        value: "true"

    - name: Set snapshot server URL in Grafana
      ini_file:
        dest: /etc/grafana/grafana.ini
        section: snapshots
        option: external_snapshot_url
        value: https://snapshots-g710.percona.com

    - name: Set name for snapshot server in Grafana
      ini_file:
        dest: /etc/grafana/grafana.ini
        section: snapshots
        option: external_snapshot_name
        value: Share with Percona

    - name: Add ClickHouse datasource to the list of unsigned plugins in Grafana
      ini_file:
        dest: /etc/grafana/grafana.ini
        section: plugins
        option: allow_loading_unsigned_plugins
        value: vertamedia-clickhouse-datasource

    - name: Create working directory for Alertmanager
      file: path=/srv/alertmanager/data state=directory owner=pmm group=pmm

    # restart pmm-managed first as it may update supervisord configuration on start
    - name: Restart pmm-managed
      command: supervisorctl {{ item }} pmm-managed
      changed_when: True
      with_items: ['stop', 'remove', 'add']

    # give pmm-managed time to update supervisord configuration,
    # and give update UI time to catch up after pmm-managed restart
    - name: Wait for pmm-managed
      pause: seconds=5

    - name: Reread supervisord configuration again
      command: supervisorctl reread
      register: reread_result
      changed_when: "'No config updates to processes' not in reread_result.stdout"

    - name: Check reread results
      debug: var=reread_result.stdout_lines

    - name: Restart services
      command: supervisorctl {{ item.1 }} {{ item.0 }}
      changed_when: True
      with_nested:
        - - nginx
          - postgresql
          - prometheus
          - alertmanager
          - clickhouse
          - grafana
          - qan-api2
          - pmm-agent
        - ['stop', 'remove', 'add']

    # set folder names of panels to format that's supported by grafana-cli
    - name: Rename Grafana community panels
      command: /usr/share/percona-dashboards/fix-panels.py
      changed_when: False

    - name: Check if Grafana Image Renderer plugin has already installed
      stat: path=/var/lib/grafana/plugins/grafana-image-renderer
      register: gird

    - name: Update Grafana Image Renderer plugin
      command: grafana-cli plugins update grafana-image-renderer
      when: gird.stat.exists and gird.stat.isdir
      changed_when: False

    - name: Install Grafana Image Renderer plugin
      command: grafana-cli plugins install grafana-image-renderer
      when: not gird.stat.exists
      changed_when: False

    - name: Start Grafana dashboards update
      command: supervisorctl start dashboard-upgrade
      changed_when: True

    - name: Update/restart other services
      command: supervisorctl update
      register: update_result
      changed_when: "'updated' in update_result.stdout"

    - name: Check other services
      debug: var=update_result.stdout_lines

    # SIGUSR2 is sent to supervisord by pmm-managed right before the update to for logging to work correctly.
    # We use that fact to show what was restarted during the update.
    - name: Get supervisord log
      shell: supervisorctl maintail -100000 | tac | awk '!flag; /received SIGUSR2/{flag = 1};' | tac
      register: maintail_result
      changed_when: False

    - name: Check supervisord log
      debug: var=maintail_result.stdout_lines
